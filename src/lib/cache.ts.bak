'use client';

// 缓存工具函数

/**
 * 缓存项接口
 */
interface CacheItem<T> {
  data: T;
  timestamp: number;
  expires?: number; // 过期时间（毫秒）
}

/**
 * 内存缓存类
 */
class MemoryCache {
  private cache: Map<string, CacheItem<any>>;

  constructor() {
    this.cache = new Map();
  }

  /**
   * 设置缓存
   * @param key 缓存键
   * @param data 缓存数据
   * @param expires 过期时间（毫秒）
   */
  set<T>(key: string, data: T, expires?: number): void {
    this.cache.set(key, {
      data,
      timestamp: Date.now(),
      expires,
    });
  }

  /**
   * 获取缓存
   * @param key 缓存键
   * @returns 缓存数据或null
   */
  get<T>(key: string): T | null {
    const item = this.cache.get(key);
    if (!item) return null;

    // 检查是否过期
    if (item.expires && Date.now() > item.timestamp + item.expires) {
      this.cache.delete(key);
      return null;
    }

    return item.data;
  }

  /**
   * 删除缓存
   * @param key 缓存键
   */
  delete(key: string): void {
    this.cache.delete(key);
  }

  /**
   * 清除所有缓存
   */
  clear(): void {
    this.cache.clear();
  }

  /**
   * 检查缓存是否存在
   * @param key 缓存键
   * @returns 是否存在
   */
  has(key: string): boolean {
    return this.cache.has(key);
  }
}

/**
 * 本地存储缓存类
 */
class LocalStorageCache {
  /**
   * 设置缓存
   * @param key 缓存键
   * @param data 缓存数据
   * @param expires 过期时间（毫秒）
   */
  set<T>(key: string, data: T, expires?: number): void {
    try {
      // 只在浏览器环境中使用localStorage
      if (typeof window !== 'undefined' && window.localStorage) {
        const item: CacheItem<T> = {
          data,
          timestamp: Date.now(),
          expires,
        };
        window.localStorage.setItem(key, JSON.stringify(item));
      }
    } catch (error) {
      console.error('LocalStorage设置缓存失败:', error);
    }
  }

  /**
   * 获取缓存
   * @param key 缓存键
   * @returns 缓存数据或null
   */
  get<T>(key: string): T | null {
    try {
      // 只在浏览器环境中使用localStorage
      if (typeof window === 'undefined' || !window.localStorage) {
        return null;
      }
      
      const itemStr = window.localStorage.getItem(key);
      if (!itemStr) return null;

      const item: CacheItem<T> = JSON.parse(itemStr);

      // 检查是否过期
      if (item.expires && Date.now() > item.timestamp + item.expires) {
        window.localStorage.removeItem(key);
        return null;
      }

      return item.data;
    } catch (error) {
      console.error('LocalStorage获取缓存失败:', error);
      return null;
    }
  }

  /**
   * 删除缓存
   * @param key 缓存键
   */
  delete(key: string): void {
    try {
      // 只在浏览器环境中使用localStorage
      if (typeof window !== 'undefined' && window.localStorage) {
        window.localStorage.removeItem(key);
      }
    } catch (error) {
      console.error('LocalStorage删除缓存失败:', error);
    }
  }

  /**
   * 清除所有缓存
   */
  clear(): void {
    try {
      // 只在浏览器环境中使用localStorage
      if (typeof window !== 'undefined' && window.localStorage) {
        window.localStorage.clear();
      }
    } catch (error) {
      console.error('LocalStorage清除缓存失败:', error);
    }
  }

  /**
   * 检查缓存是否存在
   * @param key 缓存键
   * @returns 是否存在
   */
  has(key: string): boolean {
    try {
      // 只在浏览器环境中使用localStorage
      if (typeof window === 'undefined' || !window.localStorage) {
        return false;
      }
      
      return window.localStorage.getItem(key) !== null;
    } catch (error) {
      console.error('LocalStorage检查缓存失败:', error);
      return false;
    }
  }
}

/**
 * 会话存储缓存类
 */
class SessionStorageCache {
  /**
   * 设置缓存
   * @param key 缓存键
   * @param data 缓存数据
   * @param expires 过期时间（毫秒）
   */
  set<T>(key: string, data: T, expires?: number): void {
    try {
      // 只在浏览器环境中使用sessionStorage
      if (typeof window !== 'undefined' && window.sessionStorage) {
        const item: CacheItem<T> = {
          data,
          timestamp: Date.now(),
          expires,
        };
        window.sessionStorage.setItem(key, JSON.stringify(item));
      }
    } catch (error) {
      console.error('SessionStorage设置缓存失败:', error);
    }
  }

  /**
   * 获取缓存
   * @param key 缓存键
   * @returns 缓存数据或null
   */
  get<T>(key: string): T | null {
    try {
      // 只在浏览器环境中使用sessionStorage
      if (typeof window === 'undefined' || !window.sessionStorage) {
        return null;
      }
      
      const itemStr = window.sessionStorage.getItem(key);
      if (!itemStr) return null;

      const item: CacheItem<T> = JSON.parse(itemStr);

      // 检查是否过期
      if (item.expires && Date.now() > item.timestamp + item.expires) {
        window.sessionStorage.removeItem(key);
        return null;
      }

      return item.data;
    } catch (error) {
      console.error('SessionStorage获取缓存失败:', error);
      return null;
    }
  }

  /**
   * 删除缓存
   * @param key 缓存键
   */
  delete(key: string): void {
    try {
      // 只在浏览器环境中使用sessionStorage
      if (typeof window !== 'undefined' && window.sessionStorage) {
        window.sessionStorage.removeItem(key);
      }
    } catch (error) {
      console.error('SessionStorage删除缓存失败:', error);
    }
  }

  /**
   * 清除所有缓存
   */
  clear(): void {
    try {
      // 只在浏览器环境中使用sessionStorage
      if (typeof window !== 'undefined' && window.sessionStorage) {
        window.sessionStorage.clear();
      }
    } catch (error) {
      console.error('SessionStorage清除缓存失败:', error);
    }
  }

  /**
   * 检查缓存是否存在
   * @param key 缓存键
   * @returns 是否存在
   */
  has(key: string): boolean {
    try {
      // 只在浏览器环境中使用sessionStorage
      if (typeof window === 'undefined' || !window.sessionStorage) {
        return false;
      }
      
      return window.sessionStorage.getItem(key) !== null;
    } catch (error) {
      console.error('SessionStorage检查缓存失败:', error);
      return false;
    }
  }
}

// 导出缓存实例
export const memoryCache = new MemoryCache();
export const localStorageCache = new LocalStorageCache();
export const sessionStorageCache = new SessionStorageCache();

/**
 * 多级缓存类
 */
export class MultiLevelCache {
  /**
   * 设置缓存
   * @param key 缓存键
   * @param data 缓存数据
   * @param options 缓存选项
   */
  set<T>(key: string, data: T, options?: {
    memoryExpires?: number | false;
    localExpires?: number | false;
    sessionExpires?: number | false;
  }): void {
    // 设置内存缓存
    if (options?.memoryExpires !== false) {
      memoryCache.set(key, data, options?.memoryExpires as number | undefined);
    }

    // 设置本地存储缓存
    if (options?.localExpires !== false) {
      localStorageCache.set(key, data, options?.localExpires as number | undefined);
    }

    // 设置会话存储缓存
    if (options?.sessionExpires !== false) {
      sessionStorageCache.set(key, data, options?.sessionExpires as number | undefined);
    }
  }

  /**
   * 获取缓存
   * @param key 缓存键
   * @returns 缓存数据或null
   */
  get<T>(key: string): T | null {
    // 先从内存缓存获取
    let data = memoryCache.get<T>(key);
    if (data !== null) return data;

    // 再从会话存储获取
    data = sessionStorageCache.get<T>(key);
    if (data !== null) {
      // 同步到内存缓存
      memoryCache.set(key, data);
      return data;
    }

    // 最后从本地存储获取
    data = localStorageCache.get<T>(key);
    if (data !== null) {
      // 同步到内存和会话存储
      memoryCache.set(key, data);
      sessionStorageCache.set(key, data);
      return data;
    }

    return null;
  }

  /**
   * 删除缓存
   * @param key 缓存键
   */
  delete(key: string): void {
    memoryCache.delete(key);
    sessionStorageCache.delete(key);
    localStorageCache.delete(key);
  }

  /**
   * 清除所有缓存
   */
  clear(): void {
    memoryCache.clear();
    sessionStorageCache.clear();
    localStorageCache.clear();
  }

  /**
   * 检查缓存是否存在
   * @param key 缓存键
   * @returns 是否存在
   */
  has(key: string): boolean {
    return memoryCache.has(key) || sessionStorageCache.has(key) || localStorageCache.has(key);
  }
}

// 导出默认的多级缓存实例
export const cache = new MultiLevelCache();

/**
 * 缓存键生成器
 */
export const generateCacheKey = (prefix: string, ...args: any[]): string => {
  const params = args.map(arg => {
    if (typeof arg === 'object' && arg !== null) {
      return JSON.stringify(arg);
    }
    return String(arg);
  }).join('_');
  return `${prefix}:${params}`;
};
