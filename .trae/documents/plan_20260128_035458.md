# 修复 'self is not defined' 构建错误

## 问题分析

### 根本原因
- **环境差异**：`self` 是浏览器环境的全局对象，在 Node.js 服务器端环境中不存在
- **缓存实现**：`src/lib/cache.ts` 文件中使用了浏览器特有的 API（localStorage、sessionStorage）
- **服务器端渲染**：当代码在服务器端执行时，尝试访问浏览器特有的全局对象
- **构建打包**：Webpack 在打包过程中可能没有正确处理浏览器和服务器端的环境差异

### 具体问题
1. **缓存实例导出**：模块级别导出的缓存实例可能在服务器端导入时执行
2. **第三方依赖**：某些依赖可能在导入时就使用了 `self` 对象
3. **Webpack 配置**：缺少对服务器端构建的特殊处理

## 解决方案

### 1. 修改缓存文件
- **添加 'use client' 指令**：在 `src/lib/cache.ts` 文件顶部添加 `'use client'` 指令，确保该文件只在客户端执行
- **优化环境检查**：确保所有浏览器特有的代码都有适当的环境检查
- **延迟实例创建**：考虑使用函数式方法延迟缓存实例的创建，直到在客户端执行时

### 2. 修复 Webpack 配置
- **移除不必要的配置**：删除之前添加的 `self` 模拟实现，因为这可能导致其他问题
- **恢复原始配置**：恢复 `next.config.js` 文件的原始配置，移除对 `self` 的特殊处理

### 3. 验证修复
- **运行构建命令**：执行 `pnpm run build` 验证修复是否成功
- **测试开发服务器**：确保开发服务器仍然正常运行
- **检查缓存功能**：验证客户端缓存功能是否正常工作

## 技术要点

### 缓存文件修改
- 添加 `'use client'` 指令，确保文件只在客户端执行
- 保持现有的环境检查逻辑，确保浏览器特有的 API 只在浏览器环境中使用
- 确保缓存实例的创建不会在服务器端执行时导致错误

### Webpack 配置修改
- 恢复 `next.config.js` 文件的原始配置
- 移除对 `self` 的特殊处理，因为这可能导致其他构建问题
- 依赖 Next.js 默认的构建配置来处理服务器端和客户端的环境差异

## 预期结果
- 成功解决 `self is not defined` 构建错误
- 项目能够正常构建和运行
- 客户端缓存功能正常工作
- 服务器端渲染不受影响

## 实施步骤
1. **修改缓存文件**：在 `src/lib/cache.ts` 文件顶部添加 `'use client'` 指令
2. **恢复 Webpack 配置**：删除 `next.config.js` 文件中对 `self` 的特殊处理
3. **验证修复**：运行构建命令和开发服务器验证修复效果
4. **测试功能**：确保缓存功能和其他功能正常工作