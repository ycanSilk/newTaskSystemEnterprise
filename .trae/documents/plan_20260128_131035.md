# 登录重定向和Token校验优化方案

## 问题分析

1. **重复的Token校验**：

   * middleware.ts 中的 validateToken 函数在每个请求到达时都会被调用

   * useUser.ts 中的 checkLoginStatus 函数也会定期轮询校验token

   * 这导致了大量的重复token校验请求，增加了服务器压力

2. **导航页一直显示加载中**：

   * dashboard/page.tsx 中的 loading 状态可能没有正确设置

   * fetchTasks 函数可能没有正确处理错误或完成状态

   * 可能存在无限循环的加载逻辑

3. **路由守卫和权限控制**：

   * 目前的路由守卫逻辑可能不够完善

   * 非法路由跳转没有被正确处理

4. **Token校验时机**：

   * Token校验应该在登录成功后才开启

   * 应该采用无感校验刷新机制

   * 当token失效时应该立即重定向到登录页

## 优化方案

### 1. 优化middleware.ts

* **改进Token校验逻辑**：

  * 登录成功后会自动把token保存到cookie中，只需要实现Token缓存机制，定时读取token，避免短时间内重复校验。

  * 还有token失效或者更新后才被动校验token

  * 优化路由守卫功能，正确处理非法路由跳转，非法跳转重定向到登录页面，

  * 只对需要保护的路径进行Token校验

  * 可以移除登录判断校验。因为跟token校验的机制重复了。保留token校验即可

* **具体修改**：

  * 添加Token校验结果缓存，缓存时间5分钟

  * 优化路由匹配逻辑，减少不必要的校验

  * 改进错误处理，确保Token失效时立即重定向

### 2. 优化useUser.ts

* **改进Token校验时机**：

  * 只在登录成功后开启Token校验

  * 实现无感校验刷新机制

  * 优化轮询逻辑，减少不必要的请求

* **具体修改**：

  * 添加登录状态标记，只在登录成功后开启轮询

  * 优化轮询间隔，从60秒调整为120秒

  * 实现Token校验结果缓存，避免重复请求

### 3. 修复dashboard页面

* **确保loading状态正确设置**：

  * 修复fetchTasks函数，确保loading状态在数据获取完成后正确设置为false

  * 改进错误处理，确保错误状态正确显示

  * 优化数据获取逻辑，避免无限循环加载

* **具体修改**：

  * 修复fetchTasks函数中的loading状态设置

  * 改进初始化逻辑，确保数据正确加载

  * 优化组件渲染，避免不必要的重渲染

### 4. 优化登录页面

* **确保登录成功后正确跳转**：

  * 优化登录成功后的重定向逻辑，避免重复重定向

  * 确保只在必要时进行重定向

  * 改进错误处理，确保登录失败时正确显示错误信息

* **具体修改**：

  * 优化useEffect中的重定向逻辑，确保只在登录成功后执行

  * 改进登录表单的提交逻辑，确保登录成功后立即跳转

  * 优化错误处理，确保登录失败时正确显示错误信息

### 5. 优化store/userStore.ts

* **改进用户状态管理**：

  * 优化用户状态的存储和更新逻辑

  * 确保Token状态正确同步

  * 改进错误处理，确保状态管理的一致性

* **具体修改**：

  * 优化setUser和clearUser方法，确保状态正确更新

  * 改进fetchUser方法，避免重复请求

  * 优化状态管理，确保用户状态的一致性

### 6. 优化布局组件

* **改进路由守卫功能**：

  * 优化AuthGuard组件，确保只对需要保护的路由进行守卫

  * 改进权限控制，确保只有具有正确权限的用户才能访问相应的路由

  * 优化错误处理，确保权限不足时正确重定向

* **具体修改**：

  * 优化AuthGuard组件，实现更高效的权限控制

  * 改进布局组件，确保路由守卫正确应用

  * 优化错误处理，确保权限不足时正确重定向

## 预期效果

1. **减少服务器压力**：

   * 避免重复的Token校验请求

   * 优化轮询逻辑，减少不必要的请求

   * 改进缓存机制，避免重复数据获取

2. **改善用户体验**：

   * 登录成功后立即跳转到导航页，不再显示加载中

   * 实现无感的Token校验刷新机制

   * 确保非法路由跳转时立即重定向到登录页

3. **提高系统稳定性**：

   * 优化状态管理，确保状态的一致性

   * 改进错误处理，确保系统在各种情况下都能正确处理

   * 优化路由守卫，确保系统的安全性

## 实施步骤

1. **修改middleware.ts**：

   * 添加Token校验结果缓存

   * 优化路由匹配逻辑

   * 改进错误处理

2. **修改useUser.ts**：

   * 添加登录状态标记

   * 优化轮询逻辑

   * 实现Token校验结果缓存

3. **修复dashboard/page.tsx**：

   * 修复fetchTasks函数

   * 改进初始化逻辑

   * 优化组件渲染

4. **优化login/page.tsx**：

   * 优化重定向逻辑

   * 改进登录表单提交逻辑

   * 优化错误处理

5. **优化store/userStore.ts**：

   * 优化状态管理

   * 改进错误处理

   * 优化数据获取逻辑

6. **优化布局组件**：

   * 优化AuthGuard组件

   * 改进权限控制

   * 优化错误处理

7. **测试验证**：

   * 测试登录流程，确保登录成功后立即跳转到导航页

   * 测试Token校验，确保Token失效时立即重定向到登录页

   * 测试非法路由跳转，确保立即重定向到登录页

   * 测试系统性能，确保服务器压力减少

通过以上优化方案，我们可以解决登录重定向和Token校验的问题，提高系统的性能和稳定性，改善用户体验。
