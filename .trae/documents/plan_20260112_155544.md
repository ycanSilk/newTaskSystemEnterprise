# 上传图片模块化组件实现计划

## 1. 需求分析

根据文档 `d:\github\newTaskSystemEnterprise\上传图片组件模块化设计.md`，需要实现一个图片上传的模块化组件，包含以下核心功能：

* 图片状态管理（添加、移除、重置）

* 图片预览生成

* 上传进度跟踪

* 支持指定保存图片路径

* 内存管理（释放预览URL）

* 移除OCR相关功能

## 2. 组件结构设计

### 2.1 文件结构

```
src/
├── hooks/
│   └── useEphemeralImageManager.ts  # 图片管理Hook
└── components/
    └── imagesUpload/
        ├── ImageUpload.tsx          # 图片上传组件
        └── index.ts                  # 组件导出
```

### 2.2 核心API设计

#### Hook API (useEphemeralImageManager)

```typescript
interface UseEphemeralImageManagerReturn {
  images: File[];                                  // 当前上传的图片文件列表
  imagePreviews: string[];                         // 图片预览URL列表
  handleImageUpload: (index: number, e: React.ChangeEvent<HTMLInputElement>) => void; // 图片上传处理函数
  removeImage: (index: number) => void;            // 移除指定索引的图片
  resetImages: () => void;                         // 重置所有图片
  isUploading: boolean;                            // 是否正在上传
  uploadProgress: number;                          // 上传进度(0-100)
}

// Hook实现
export function useEphemeralImageManager(initialImages: File[] = [], savePath: string = ''): UseEphemeralImageManagerReturn {
  // 实现细节...
}
```

#### 组件API (ImageUpload)

```typescript
interface ImageUploadProps {
  initialImages?: File[];           // 初始图片列表
  maxCount?: number;                // 最大上传数量
  onImagesChange?: (images: File[]) => void;  // 图片变化回调
  savePath?: string;                // 保存图片路径
  title?: string;                   // 组件标题
}

export const ImageUpload: React.FC<ImageUploadProps> = ({
  initialImages = [],
  maxCount = 5,
  onImagesChange,
  savePath = '',
  title = '图片上传'
}) => {
  // 实现细节...
};
```

## 3. 实现步骤

### 3.1 创建图片管理Hook

1. 在 `src/hooks` 目录下创建 `useEphemeralImageManager.ts`
2. 实现Hook核心功能：

   * 图片状态管理（images, imagePreviews）

   * 上传处理（handleImageUpload）

   * 图片移除（removeImage）

   * 重置功能（resetImages）

   * 上传进度跟踪（isUploading, uploadProgress）

   * 支持保存路径参数（savePath）

   * 内存管理（释放预览URL）

### 3.2 创建图片上传组件

1. 创建 `src/components/imagesUpload` 目录
2. 在该目录下创建 `ImageUpload.tsx`
3. 实现组件核心功能：

   * 使用 `useEphemeralImageManager` Hook

   * 支持最大上传数量限制

   * 图片预览显示

   * 上传按钮和移除功能

   * 进度条显示

   * 支持保存路径配置

   * 响应式布局

   * 移除OCR相关功能

### 3.3 创建组件导出文件

1. 在 `src/components/imagesUpload` 目录下创建 `index.ts`
2. 导出 `ImageUpload` 组件，方便外部使用

## 4. 关键实现细节

### 4.1 图片上传处理

* 使用 `URL.createObjectURL()` 生成预览

* 模拟上传进度（0-100%）

* 支持JPG/PNG格式验证

* 文件大小限制（200KB）

### 4.2 内存管理

* 在组件卸载时调用 `URL.revokeObjectURL()` 释放资源

* 在重置图片时释放所有预览URL

### 4.3 保存路径支持

* 将保存路径传递给Hook

* 在上传处理中使用该路径

* 支持自定义路径配置

## 5. 代码实现规范

* 使用TypeScript确保类型安全

* 遵循项目现有代码风格

* 使用React最佳实践

* 添加必要的注释

* 确保组件可复用性和可扩展性

## 6. 测试要点

* 图片上传功能是否正常

* 预览是否正确显示

* 移除图片功能是否正常

* 重置功能是否正常

* 上传进度是否准确

* 内存是否正确释放

* 保存路径参数是否生效

## 7. 预期效果

* 支持多图片上传（默认最多5张）

* 实时预览上传的图片

* 显示上传进度

* 支持移除和重置操作

* 支持自定义保存路径

* 内存管理良好，无内存泄漏

* 移除所有OCR相关功能

这个计划确保了组件的模块化设计，符合文档要求，同时移除了OCR相关功能，适合作为纯图片上传组件使用。
