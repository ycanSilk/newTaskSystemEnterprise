终极简化版图片上传管理 Hook：useEphemeralImageManager 实现方案
概述

useEphemeralImageManager是一个专为图片上传场景设计的简易 React Hook，它提供了图片状态管理和基本操作功能，同时保持了极简的设计理念。该 Hook 不依赖外部状态管理库，完全自包含，适合中小型项目或简单组件使用。

Hook 功能设计
核心功能

图片状态管理

维护当前上传的图片列表

支持添加新图片

支持移除已有图片

基本操作

图片上传处理

图片删除处理

图片预览生成

状态重置

快速清空所有已上传图片

API 设计
typescript
复制
interface UseEphemeralImageManagerReturn {
  images: File[]; // 当前上传的图片文件列表
  imagePreviews: string[]; // 图片预览URL列表
  handleImageUpload: (index: number, e: React.ChangeEvent<HTMLInputElement>) => void; // 图片上传处理函数
  removeImage: (index: number) => void; // 移除指定索引的图片
  resetImages: () => void; // 重置所有图片
  isUploading: boolean; // 是否正在上传
  uploadProgress: number; // 上传进度(0-100)
}
实现代码

以下是 useEphemeralImageManager的完整实现：

typescript
复制
// hooks/useEphemeralImageManager.ts
import { useState, useCallback } from 'react';

type ImageHandler = (index: number, e: React.ChangeEvent<HTMLInputElement>) => void;

export function useEphemeralImageManager(initialImages: File[] = []) {
  const [images, setImages] = useState<File[]>(initialImages);
  const [imagePreviews, setImagePreviews] = useState<string[]>([]);
  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);

  // 生成图片预览URL
  const generatePreviews = useCallback((newImages: File[]) => {
    return newImages.map(file => URL.createObjectURL(file));
  }, []);

  // 处理图片上传
  const handleImageUpload: ImageHandler = useCallback((index, e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // 验证文件类型和大小
    if (!['image/jpeg', 'image/png'].includes(file.type)) {
      alert('请上传 JPG 或 PNG 格式的图片');
      return;
    }

    if (file.size > 200 * 1024) { // 200KB
      alert('图片大小不能超过 200KB');
      return;
    }

    setIsUploading(true);
    setUploadProgress(0);

    // 模拟上传进度
    const progressInterval = setInterval(() => {
      setUploadProgress(prev => {
        const newProgress = prev + 5;
        if (newProgress >= 95) {
          clearInterval(progressInterval);
          setTimeout(() => {
            setIsUploading(false);
            // 更新图片列表和预览
            const newImages = [...images];
            newImages[index] = file;
            setImages(newImages);
            setImagePreviews(generatePreviews(newImages));
          }, 300);
        }
        return newProgress;
      });
    }, 300);
  }, [images, generatePreviews]);

  // 移除图片
  const removeImage = useCallback((index: number) => {
    const newImages = [...images];
    newImages.splice(index, 1);
    setImages(newImages);
    setImagePreviews(generatePreviews(newImages));
  }, [images, generatePreviews]);

  // 重置所有图片
  const resetImages = useCallback(() => {
    // 释放预览URL占用的内存
    imagePreviews.forEach(url => URL.revokeObjectURL(url));
    setImages([]);
    setImagePreviews([]);
  }, [imagePreviews]);

  // 组件卸载时清理预览URL
  React.useEffect(() => {
    return () => {
      imagePreviews.forEach(url => URL.revokeObjectURL(url));
    };
  }, [imagePreviews]);

  return {
    images,
    imagePreviews,
    handleImageUpload,
    removeImage,
    resetImages,
    isUploading,
    uploadProgress
  };
}
组件集成示例

以下是如何在组件中使用此 Hook 的示例：

tsx
复制
// components/ImageUploadWithOCR.tsx
import React from 'react';
import { useEphemeralImageManager } from '../hooks/useEphemeralImageManager';

interface ImageUploadWithOCRProps {
  initialImages?: File[];
  maxCount?: number;
  onImagesChange?: (images: File[]) => void;
}

const ImageUploadWithOCR: React.FC<ImageUploadWithOCRProps> = ({
  initialImages = [],
  maxCount = 5,
  onImagesChange
}) => {
  const {
    images,
    imagePreviews,
    handleImageUpload,
    removeImage,
    resetImages,
    isUploading,
    uploadProgress
  } = useEphemeralImageManager(initialImages);

  // 通知父组件图片变化
  React.useEffect(() => {
    onImagesChange?.(images);
  }, [images, onImagesChange]);

  // OCR处理函数（模拟）
  const handleOCR = async (imageFile: File) => {
    if (!imageFile) return '';
    
    setIsUploading(true);
    setUploadProgress(0);
    
    // 模拟OCR处理时间
    return new Promise<string>((resolve) => {
      const progressInterval = setInterval(() => {
        setUploadProgress(prev => {
          const newProgress = prev + 10;
          if (newProgress >= 100) {
            clearInterval(progressInterval);
            setTimeout(() => {
              setIsUploading(false);
              // 模拟OCR结果
              resolve('这是从图片中识别出的文字内容...');
            }, 300);
          }
          return newProgress;
        });
      }, 100);
    });
  };

  // 上传后处理
  const handleAfterUpload = async (index: number) => {
    if (images[index]) {
      const ocrResult = await handleOCR(images[index]);
      console.log('OCR结果:', ocrResult);
      // 可以在这里处理OCR结果
    }
  };

  const handleImageUploaded = async (index: number) => {
    await handleAfterUpload(index);
  };

  return (
    <div className="image-upload-container">
      <div className="image-upload-grid">
        {Array.from({ length: maxCount }).map((_, index) => (
          <div 
            key={index} 
            className={`image-upload-item ${images[index] ? 'has-image' : 'empty-slot'}`}
          >
            {images[index] ? (
              <>
                <img 
                  src={imagePreviews[index]} 
                  alt={`上传图片 ${index + 1}`} 
                  className="uploaded-image"
                />
                <button 
                  onClick={() => removeImage(index)}
                  className="remove-button"
                >
                  ×
                </button>
              </>
            ) : (
              <label className="upload-label">
                <span className="upload-icon">+</span>
                <span className="upload-text">点击上传</span>
                <input
                  type="file"
                  accept="image/jpeg,image/png"
                  onChange={(e) => {
                    handleImageUpload(index, e);
                    handleImageUploaded(index);
                  }}
                  className="hidden-input"
                />
              </label>
            )}
            
            {uploadProgress > 0 && uploadProgress < 100 && index === images.length - 1 && (
              <div className="progress-bar">
                <div 
                  className="progress-fill" 
                  style={{ width: `${uploadProgress}%` }}
                />
              </div>
            )}
          </div>
        ))}
      </div>
      
      <button 
        onClick={resetImages} 
        disabled={images.length === 0}
        className="reset-button"
      >
        重置所有图片
      </button>
    </div>
  );
};

export default ImageUploadWithOCR;
优化与扩展
性能优化

内存管理

使用 URL.revokeObjectURL()及时释放预览URL

在组件卸载时自动清理

渲染优化

使用 useCallback缓存回调函数

避免不必要的重新渲染

扩展可能性

添加图片压缩功能

typescript
复制
const compressImage = (file: File): Promise<File> => {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target?.result as string;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d')!;

        // 计算压缩比例
        const MAX_WIDTH = 800;
        const MAX_HEIGHT = 800;
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > MAX_WIDTH) {
            height *= MAX_WIDTH / width;
            width = MAX_WIDTH;
          }
        } else {
          if (height > MAX_HEIGHT) {
            width *= MAX_HEIGHT / height;
            height = MAX_HEIGHT;
          }
        }

        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);

        canvas.toBlob((blob) => {
          resolve(new File([blob!], file.name, { type: 'image/jpeg' }));
        }, 'image/jpeg', 0.7); // 0.7质量
      };
    };
  });
};

添加拖拽上传功能

typescript
复制
const handleDragOver = (e: React.DragEvent<HTMLDivElement>) => {
  e.preventDefault();
  e.stopPropagation();
  // 添加拖拽样式
};

const handleDrop = (e: React.DragEvent<HTMLDivElement>) => {
  e.preventDefault();
  e.stopPropagation();
  // 处理拖拽的文件
};

添加图片预览旋转功能

typescript
复制
const rotateImage = (index: number) => {
  // 实现图片旋转逻辑
};
使用指南
基本用法
tsx
复制
import ImageUploadWithOCR from './components/ImageUploadWithOCR';

function App() {
  const handleImagesChange = (images: File[]) => {
    console.log('当前图片:', images);
  };

  return (
    <div className="app">
      <h1>图片上传与OCR识别</h1>
      <ImageUploadWithOCR 
        onImagesChange={handleImagesChange}
      />
    </div>
  );
}

export default App;
自定义配置
tsx
复制
<ImageUploadWithOCR
  initialImages={[/* 初始图片 */]}
  maxCount={10} // 最大上传数量
  onImagesChange={(images) => {
    // 处理图片变化
  }}
/>
总结

还要支持指定保存图片路径的参数。 
useEphemeralImageManagerHook 提供了一种简洁而强大的方式来管理图片上传状态，其特点包括：

极简设计：仅关注核心功能，无多余复杂性

完全自包含：不依赖外部状态管理库

易于集成：可轻松整合到现有项目中

可扩展性强：提供基础功能，方便添加额外特性